# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–≥–æ–≤ —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

## üêõ –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### –ü—Ä–æ–±–ª–µ–º–∞ #1: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ
–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–ø—É—Å–∫–µ –∏–º–ø–æ—Ä—Ç–∞ —Å —Ñ–ª–∞–≥–æ–º `--refresh-images` —Å–æ–∑–¥–∞–≤–∞–ª–∏—Å—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π, –∞ —Å—Ç–∞—Ä—ã–µ –æ—Å—Ç–∞–≤–∞–ª–∏—Å—å –Ω–∞ –¥–∏—Å–∫–µ.

**–ü—Ä–∏—á–∏–Ω–∞**: –§—É–Ω–∫—Ü–∏—è `download_image()` –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–µ UUID-–∏–º—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ñ–∞–π–ª–∞:
```python
filename = f"{uuid.uuid4()}.webp"  # –ö–∞–∂–¥—ã–π —Ä–∞–∑ –Ω–æ–≤–æ–µ –∏–º—è!
```

**–ü–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è**: 
- –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ —Å `--refresh-images` –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ —É–¥–≤–∞–∏–≤–∞–ª–æ—Å—å
- –ó–∞–Ω–∏–º–∞–µ–º–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ —Ä–æ—Å–ª–æ –ª–∏–Ω–µ–π–Ω–æ
- –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã —Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å "–º—É—Å–æ—Ä–æ–º"

### –ü—Ä–æ–±–ª–µ–º–∞ #2: –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—á–∏—Å—Ç–∫–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞–ø–∏—Å–µ–π –∏–∑ –ë–î
–ö–æ–¥ —É–¥–∞–ª—è–ª –∑–∞–ø–∏—Å–∏ `ProductImage` –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö, –Ω–æ –Ω–µ —É–¥–∞–ª—è–ª —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã —Å –¥–∏—Å–∫–∞.

```python
# –°—Ç–∞—Ä—ã–π –∫–æ–¥ - —É–¥–∞–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
session.execute(delete(ProductImage).where(ProductImage.product_id == product.id))
```

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #1: –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–§–∞–π–ª**: `app/utils/import_4roads_full.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è**:
```python
# –ù–æ–≤—ã–π –∫–æ–¥ - —É–¥–∞–ª—è–µ—Ç –∏ —Ñ–∞–π–ª—ã, –∏ –∑–∞–ø–∏—Å–∏ –≤ –ë–î
if refresh_images and status != "skipped":
    # –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–µ–π –∏–∑ –ë–î
    old_images = session.scalars(
        select(ProductImage).where(ProductImage.product_id == product.id)
    ).all()
    images_dir = Path(APP_CONFIG.IMAGES_DIR)
    
    # –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å –¥–∏—Å–∫–∞
    for old_img in old_images:
        old_file_path = images_dir / old_img.image_path
        if old_file_path.exists():
            try:
                old_file_path.unlink()
            except Exception as exc:
                print(f"[{index}] failed to delete old image file {old_file_path}: {exc}")
    
    # –£–¥–∞–ª—è–µ–º –∑–∞–ø–∏—Å–∏ –∏–∑ –ë–î
    session.execute(delete(ProductImage).where(ProductImage.product_id == product.id))
    session.flush()
```

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ #2: –£—Ç–∏–ª–∏—Ç–∞ –æ—á–∏—Å—Ç–∫–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–§–∞–π–ª**: `app/utils/cleanup_orphaned_images.py`

–ù–æ–≤–∞—è —É—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ —É–¥–∞–ª–µ–Ω–∏—è "–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö" —Ñ–∞–π–ª–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π.

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ**:

```bash
# –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤ (–±–µ–∑ —É–¥–∞–ª–µ–Ω–∏—è)
python -m app.utils.cleanup_orphaned_images

# –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ–∞–π–ª—ã
python -m app.utils.cleanup_orphaned_images --execute
```

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç**:
1. –ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—É—Ç–µ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
2. –°–∫–∞–Ω–∏—Ä—É–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é `static/images/products/` –Ω–∞ –Ω–∞–ª–∏—á–∏–µ `*.webp` —Ñ–∞–π–ª–æ–≤
3. –ù–∞—Ö–æ–¥–∏—Ç —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ –ë–î (orphaned/–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ)
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
5. –ü—Ä–∏ —Ñ–ª–∞–≥–µ `--execute` —É–¥–∞–ª—è–µ—Ç –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ–∞–π–ª—ã

## üìã –°—Ü–µ–Ω–∞—Ä–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–µ—Ä–≤—ã–π –∏–º–ø–æ—Ä—Ç –ø—Ä–æ–¥—É–∫—Ç–æ–≤
```bash
python -m app.utils.import_4roads_full --collection-url https://4roads.su/collection/vse-kollektsii
```
‚úÖ –°–æ–∑–¥–∞—é—Ç—Å—è –ø—Ä–æ–¥—É–∫—Ç—ã –∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
```bash
python -m app.utils.import_4roads_full --collection-url https://4roads.su/collection/vse-kollektsii
```
‚úÖ –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è —Ü–µ–Ω—ã, –æ–ø–∏—Å–∞–Ω–∏—è, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ —Ç—Ä–æ–≥–∞—é—Ç—Å—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –∑–∞–º–µ–Ω–æ–π –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
```bash
python -m app.utils.import_4roads_full --collection-url https://4roads.su/collection/vse-kollektsii --refresh-images
```
‚úÖ –°—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —É–¥–∞–ª—è—é—Ç—Å—è —Å –¥–∏—Å–∫–∞
‚úÖ –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î —É–¥–∞–ª—è—é—Ç—Å—è
‚úÖ –°–∫–∞—á–∏–≤–∞—é—Ç—Å—è –∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –Ω–æ–≤—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—á–∏—Å—Ç–∫–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏/–±–∞–≥–æ–≤
```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫–æ–ª—å–∫–æ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤
python -m app.utils.cleanup_orphaned_images

# –£–¥–∞–ª–∏—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ñ–∞–π–ª—ã
python -m app.utils.cleanup_orphaned_images --execute
```

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –¥—É–±–ª–µ–π

1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤**:
```bash
ls -1 static/images/products/*.webp | wc -l
```

2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –≤ –ë–î**:
```sql
SELECT COUNT(*) FROM product_images;
```

3. **–ó–∞–ø—É—Å—Ç–∏—Ç—å —É—Ç–∏–ª–∏—Ç—É –æ—á–∏—Å—Ç–∫–∏**:
```bash
python -m app.utils.cleanup_orphaned_images
```

–ï—Å–ª–∏ –≤—ã–≤–æ–¥ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–ù–∞–π–¥–µ–Ω–æ N –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ–∞–π–ª–æ–≤" - –∑–Ω–∞—á–∏—Ç –µ—Å—Ç—å –¥—É–±–ª–∏.

## üéØ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `--refresh-images` —Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω—É–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è**
   - –û–±—ã—á–Ω—ã–π –∏–º–ø–æ—Ä—Ç –±–µ–∑ —Ñ–ª–∞–≥–∞ –Ω–µ —Ç—Ä–æ–≥–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤

2. **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –æ—á–∏—Å—Ç–∫—É**:
```bash
python -m app.utils.cleanup_orphaned_images --execute
```

3. **–î–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–≥–∞**:
```bash
# –û—á–∏—Å—Ç–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥—É–±–ª–∏
python -m app.utils.cleanup_orphaned_images --execute

# –î–∞–ª–µ–µ –∏–º–ø–æ—Ä—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
python -m app.utils.import_4roads_full --collection-url https://4roads.su/...
```

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
- `app/utils/import_4roads_full.py` - –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `app/utils/cleanup_orphaned_images.py` - –Ω–æ–≤–∞—è —É—Ç–∏–ª–∏—Ç–∞ –æ—á–∏—Å—Ç–∫–∏

### –ú–æ–¥–µ–ª–∏ –ë–î:
```python
# ProductImage –∏–º–µ–µ—Ç cascade="all, delete-orphan"
# –ù–æ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —á–µ—Ä–µ–∑ ORM, –Ω–µ —á–µ—Ä–µ–∑ execute(delete(...))
class Product(Base):
    images: Mapped[list["ProductImage"]] = relationship(
        back_populates="product",
        cascade="all, delete-orphan"
    )
```

**–í–∞–∂–Ω–æ**: Cascade —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ relationship –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ `session.execute(delete(...))`, –ø–æ—ç—Ç–æ–º—É –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–¥–∞–ª—è—Ç—å —Ñ–∞–π–ª—ã –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –∑–∞–ø–∏—Å–µ–π.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

```bash
# 1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–¥—É–∫—Ç—ã
python -m app.utils.import_4roads_full --collection-url https://4roads.su/collection/vse-kollektsii --max-pages 1

# 2. –ü–æ–¥—Å—á–∏—Ç–∞–µ–º —Ñ–∞–π–ª—ã –∏ –∑–∞–ø–∏—Å–∏
FILES_COUNT=$(ls -1 static/images/products/*.webp 2>/dev/null | wc -l)
echo "–§–∞–π–ª–æ–≤ –Ω–∞ –¥–∏—Å–∫–µ: $FILES_COUNT"

# 3. –ó–∞–ø—É—Å—Ç–∏–º –ø–æ–≤—Ç–æ—Ä–Ω–æ —Å refresh-images
python -m app.utils.import_4roads_full --collection-url https://4roads.su/collection/vse-kollektsii --max-pages 1 --refresh-images

# 4. –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ–∞–π–ª–æ–≤ –Ω–µ —É–≤–µ–ª–∏—á–∏–ª–æ—Å—å
FILES_COUNT_AFTER=$(ls -1 static/images/products/*.webp 2>/dev/null | wc -l)
echo "–§–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ refresh: $FILES_COUNT_AFTER"

# 5. –ü—Ä–æ–≤–µ—Ä–∏–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏—Ö —Ñ–∞–π–ª–æ–≤
python -m app.utils.cleanup_orphaned_images
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: "–ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ" ‚úÖ

